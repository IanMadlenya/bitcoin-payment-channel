<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>src/Data/Bitcoin/PaymentChannel/Internal/Script.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>-- {-# OPTIONS_GHC -fwarn-incomplete-patterns -Werror #-}</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Bitcoin</span><span class='hs-varop'>.</span><span class='hs-conid'>PaymentChannel</span><span class='hs-varop'>.</span><span class='hs-conid'>Internal</span><span class='hs-varop'>.</span><span class='hs-conid'>Script</span> <span class='hs-keyword'>where</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Bitcoin</span><span class='hs-varop'>.</span><span class='hs-conid'>PaymentChannel</span><span class='hs-varop'>.</span><span class='hs-conid'>Internal</span><span class='hs-varop'>.</span><span class='hs-conid'>Types</span>
<a name="line-6"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Bitcoin</span><span class='hs-varop'>.</span><span class='hs-conid'>PaymentChannel</span><span class='hs-varop'>.</span><span class='hs-conid'>Internal</span><span class='hs-varop'>.</span><span class='hs-conid'>Serialization</span>
<a name="line-7"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Bitcoin</span><span class='hs-varop'>.</span><span class='hs-conid'>PaymentChannel</span><span class='hs-varop'>.</span><span class='hs-conid'>Internal</span><span class='hs-varop'>.</span><span class='hs-conid'>Util</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span>  <span class='hs-conid'>Network</span><span class='hs-varop'>.</span><span class='hs-conid'>Haskoin</span><span class='hs-varop'>.</span><span class='hs-conid'>Internals</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>HI</span>
<a name="line-10"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span>  <span class='hs-conid'>Network</span><span class='hs-varop'>.</span><span class='hs-conid'>Haskoin</span><span class='hs-varop'>.</span><span class='hs-conid'>Util</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>HU</span>
<a name="line-11"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span>  <span class='hs-conid'>Network</span><span class='hs-varop'>.</span><span class='hs-conid'>Haskoin</span><span class='hs-varop'>.</span><span class='hs-conid'>Crypto</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>HC</span>
<a name="line-12"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Network</span><span class='hs-varop'>.</span><span class='hs-conid'>Haskoin</span><span class='hs-varop'>.</span><span class='hs-conid'>Script</span>
<a name="line-13"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>Script</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>SigHash</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>ScriptOp</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>opPushData</span><span class='hs-layout'>)</span>
<a name="line-14"></a>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>B</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span><span class='hs-varop'>.</span><span class='hs-conid'>Char8</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>C</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span><span class='hs-varop'>.</span><span class='hs-conid'>Lazy</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>BL</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Binary</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Bin</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Word</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Char</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>CH</span>
<a name="line-21"></a>
<a name="line-22"></a><a name="valReceiverSigHash"></a><span class='hs-definition'>valReceiverSigHash</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SigAll</span> <span class='hs-conid'>True</span>
<a name="line-23"></a>
<a name="line-24"></a><a name="getSigHashFlag"></a><span class='hs-definition'>getSigHashFlag</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BitcoinAmount</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SigHash</span>
<a name="line-25"></a><span class='hs-definition'>getSigHashFlag</span> <span class='hs-varid'>valueToSender</span> <span class='hs-keyglyph'>=</span>
<a name="line-26"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>valueToSender</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span> <span class='hs-keyword'>then</span>
<a name="line-27"></a>        <span class='hs-conid'>SigNone</span> <span class='hs-conid'>True</span>
<a name="line-28"></a>    <span class='hs-keyword'>else</span>
<a name="line-29"></a>        <span class='hs-conid'>SigSingle</span> <span class='hs-conid'>True</span>
<a name="line-30"></a>
<a name="line-31"></a><a name="sigHashToByte"></a><span class='hs-definition'>sigHashToByte</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SigHash</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Word8</span>
<a name="line-32"></a><span class='hs-definition'>sigHashToByte</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ord</span> <span class='hs-varop'>.</span> <span class='hs-varid'>head</span> <span class='hs-varop'>.</span> <span class='hs-conid'>C</span><span class='hs-varop'>.</span><span class='hs-varid'>unpack</span> <span class='hs-varop'>.</span> <span class='hs-varid'>serialize</span>
<a name="line-33"></a>
<a name="line-34"></a><a name="paymentChannelRedeemScript"></a><span class='hs-comment'>-- |Generates OP_CHECKLOCKTIMEVERIFY redeemScript</span>
<a name="line-35"></a><span class='hs-definition'>paymentChannelRedeemScript</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HC</span><span class='hs-varop'>.</span><span class='hs-conid'>PubKey</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HC</span><span class='hs-varop'>.</span><span class='hs-conid'>PubKey</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Word32</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Script</span>
<a name="line-36"></a><span class='hs-definition'>paymentChannelRedeemScript</span> <span class='hs-varid'>clientPK</span> <span class='hs-varid'>serverPK</span> <span class='hs-varid'>lockTime</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Script</span>
<a name="line-37"></a>     <span class='hs-keyglyph'>[</span><span class='hs-conid'>OP_IF</span><span class='hs-layout'>,</span>
<a name="line-38"></a>         <span class='hs-varid'>opPushData</span> <span class='hs-layout'>(</span><span class='hs-varid'>serialize</span> <span class='hs-varid'>serverPK</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>OP_CHECKSIGVERIFY</span><span class='hs-layout'>,</span>
<a name="line-39"></a>     <span class='hs-conid'>OP_ELSE</span><span class='hs-layout'>,</span>
<a name="line-40"></a>         <span class='hs-varid'>encodeScriptInt</span> <span class='hs-varid'>lockTime</span><span class='hs-layout'>,</span> <span class='hs-varid'>op_CHECKLOCKTIMEVERIFY</span><span class='hs-layout'>,</span> <span class='hs-conid'>OP_DROP</span><span class='hs-layout'>,</span>
<a name="line-41"></a>     <span class='hs-conid'>OP_ENDIF</span><span class='hs-layout'>,</span>
<a name="line-42"></a>     <span class='hs-varid'>opPushData</span> <span class='hs-layout'>(</span><span class='hs-varid'>serialize</span> <span class='hs-varid'>clientPK</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>OP_CHECKSIG</span><span class='hs-keyglyph'>]</span>
<a name="line-43"></a>         <span class='hs-keyword'>where</span> <span class='hs-varid'>encodeScriptInt</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>opPushData</span> <span class='hs-varop'>$</span> <span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-varid'>pack</span> <span class='hs-varop'>$</span> <span class='hs-conid'>HI</span><span class='hs-varop'>.</span><span class='hs-varid'>encodeInt</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span>
<a name="line-44"></a>            <span class='hs-comment'>-- Note: HI.encodeInt encodes values up to and including 2^31-1 as 4 bytes</span>
<a name="line-45"></a>            <span class='hs-comment'>--      and values 2^31 through 2^32-1 (upper limit) as 5 bytes.</span>
<a name="line-46"></a>
<a name="line-47"></a><a name="paymentTxScriptSig"></a><span class='hs-comment'>-- |scriptSig fulfilling a payment channel redeemScript</span>
<a name="line-48"></a><span class='hs-definition'>paymentTxScriptSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PaymentSignature</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PaymentSignature</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Script</span> <span class='hs-varop'>--ScriptSig</span>
<a name="line-49"></a><span class='hs-definition'>paymentTxScriptSig</span> <span class='hs-varid'>clientSig</span> <span class='hs-varid'>serverSig</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Script</span>
<a name="line-50"></a>    <span class='hs-keyglyph'>[</span><span class='hs-varid'>opPushData</span> <span class='hs-varop'>$</span> <span class='hs-varid'>serialize</span> <span class='hs-varid'>clientSig</span><span class='hs-layout'>,</span> <span class='hs-comment'>--sig including SigHash byte</span>
<a name="line-51"></a>    <span class='hs-varid'>opPushData</span> <span class='hs-varop'>$</span> <span class='hs-varid'>serialize</span> <span class='hs-varid'>serverSig</span><span class='hs-layout'>,</span> <span class='hs-comment'>--sig including SigHash byte</span>
<a name="line-52"></a>    <span class='hs-conid'>OP_1</span><span class='hs-keyglyph'>]</span>
<a name="line-53"></a>
<a name="line-54"></a><a name="refundTxScriptSig"></a><span class='hs-comment'>-- |scriptSig used for the valueSender refund transaction</span>
<a name="line-55"></a><span class='hs-definition'>refundTxScriptSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HC</span><span class='hs-varop'>.</span><span class='hs-conid'>Signature</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Script</span>
<a name="line-56"></a><span class='hs-definition'>refundTxScriptSig</span> <span class='hs-varid'>clientSig</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Script</span>
<a name="line-57"></a>    <span class='hs-keyglyph'>[</span><span class='hs-varid'>opPushData</span> <span class='hs-layout'>(</span><span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-varid'>append</span> <span class='hs-layout'>(</span><span class='hs-varid'>serialize</span> <span class='hs-varid'>clientSig</span><span class='hs-layout'>)</span> <span class='hs-varid'>hashTypeByte</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-58"></a>    <span class='hs-conid'>OP_0</span><span class='hs-keyglyph'>]</span>
<a name="line-59"></a>        <span class='hs-keyword'>where</span> <span class='hs-varid'>hashTypeByte</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>serialize</span> <span class='hs-layout'>(</span><span class='hs-conid'>SigAll</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-60"></a>
<a name="line-61"></a><span class='hs-varop'>-----Util-----</span>
<a name="line-62"></a>
<a name="line-63"></a><a name="op_CHECKLOCKTIMEVERIFY"></a><span class='hs-definition'>op_CHECKLOCKTIMEVERIFY</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OP_NOP2</span>
<a name="line-64"></a>
<a name="line-65"></a><a name="scriptToP2SHAddress"></a><span class='hs-definition'>scriptToP2SHAddress</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Script</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HC</span><span class='hs-varop'>.</span><span class='hs-conid'>Address</span>
<a name="line-66"></a><span class='hs-definition'>scriptToP2SHAddress</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HC</span><span class='hs-varop'>.</span><span class='hs-conid'>ScriptAddress</span> <span class='hs-varop'>.</span> <span class='hs-conid'>HC</span><span class='hs-varop'>.</span><span class='hs-varid'>hash160</span> <span class='hs-varop'>.</span> <span class='hs-conid'>HC</span><span class='hs-varop'>.</span><span class='hs-varid'>getHash256</span> <span class='hs-varop'>.</span> <span class='hs-conid'>HC</span><span class='hs-varop'>.</span><span class='hs-varid'>hash256</span> <span class='hs-varop'>.</span> <span class='hs-varid'>serialize</span>
<a name="line-67"></a>
<a name="line-68"></a>
<a name="line-69"></a><a name="getP2SHFundingAddress"></a><span class='hs-definition'>getP2SHFundingAddress</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ChannelParameters</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HC</span><span class='hs-varop'>.</span><span class='hs-conid'>Address</span>
<a name="line-70"></a><span class='hs-definition'>getP2SHFundingAddress</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>scriptToP2SHAddress</span> <span class='hs-varop'>.</span> <span class='hs-varid'>getRedeemScript</span>
<a name="line-71"></a>
<a name="line-72"></a><a name="getRedeemScript"></a><span class='hs-definition'>getRedeemScript</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ChannelParameters</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Script</span> <span class='hs-varop'>--RedeemScript</span>
<a name="line-73"></a><span class='hs-definition'>getRedeemScript</span> <span class='hs-layout'>(</span><span class='hs-conid'>CChannelParameters</span> <span class='hs-varid'>senderPK</span> <span class='hs-varid'>recvrPK</span> <span class='hs-varid'>lockTime</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-74"></a>    <span class='hs-varid'>paymentChannelRedeemScript</span> <span class='hs-varid'>senderPK</span> <span class='hs-varid'>recvrPK</span> <span class='hs-layout'>(</span><span class='hs-varid'>toWord32</span> <span class='hs-varid'>lockTime</span><span class='hs-layout'>)</span>
<a name="line-75"></a>
<a name="line-76"></a><a name="getRedeemScriptBS"></a><span class='hs-definition'>getRedeemScriptBS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ChannelParameters</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span>
<a name="line-77"></a><span class='hs-definition'>getRedeemScriptBS</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>serialize</span> <span class='hs-varop'>.</span> <span class='hs-varid'>getRedeemScript</span>
<a name="line-78"></a>
<a name="line-79"></a><a name="getInputScript"></a><span class='hs-definition'>getInputScript</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ChannelParameters</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Script</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Script</span>
<a name="line-80"></a><span class='hs-definition'>getInputScript</span> <span class='hs-varid'>cp</span> <span class='hs-varid'>scriptSig</span> <span class='hs-keyglyph'>=</span>
<a name="line-81"></a>    <span class='hs-conid'>Script</span> <span class='hs-varop'>$</span> <span class='hs-varid'>scriptOps</span> <span class='hs-varid'>scriptSig</span> <span class='hs-varop'>++</span> <span class='hs-varid'>redeemScript</span>
<a name="line-82"></a>        <span class='hs-keyword'>where</span>
<a name="line-83"></a>             <span class='hs-varid'>redeemScript</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>opPushData</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getRedeemScriptBS</span> <span class='hs-varid'>cp</span><span class='hs-keyglyph'>]</span>
<a name="line-84"></a>
</pre></body>
</html>
